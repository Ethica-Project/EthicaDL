<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EthicaDL — Video Downloader UI</title>
  <meta name="description" content="Monochrome, clean UI for a yt-dlp powered video downloader." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#666666;
      --border:#e9e9e9;
      --card:#ffffff;
      --shadow: 0 12px 30px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.04);
      --shadow-soft: 0 6px 18px rgba(0,0,0,.06);
      --focus: 0 0 0 3px rgba(0,0,0,.15);
      --radius:16px;
      --radius-sm:10px;
      --gap: clamp(14px, 1.8vw, 22px);
      --maxw: 1200px;
      --padX: clamp(16px, 4vw, 28px);
      --headerH: 60px;
      --btnH: 44px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* Typography */
    h1{ font-size: clamp(28px, 5vw, 46px); line-height:1.15; letter-spacing:-.4px; margin: 10px 0 8px }
    h2.section-title{ font-size: clamp(20px, 2.5vw, 24px); margin: 6px 0 14px }
    h3{ font-size: clamp(17px, 2vw, 18px); margin: 6px 0 8px }
    p.lead{ color:var(--muted); font-size: clamp(15px, 2.1vw, 18px); max-width: 820px }
    a{ color: var(--fg); text-decoration: underline; }
    a:hover{ opacity:.85 }
    :focus-visible{ outline: none; box-shadow: var(--focus); border-radius: 8px }

    .container{max-width:var(--maxw); margin:0 auto; padding: 0 var(--padX);}

    /* Header */
    .header{
      position: sticky; top:0; z-index: 100;
      background: rgba(255,255,255,.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .nav{ display:flex; align-items:center; gap:12px; min-height: var(--headerH); }
    .logo{ font-weight:800; letter-spacing:.2px; font-size: 20px; display:flex; align-items:center; gap:8px; white-space: nowrap }
    .logo .dot{ width:10px; height:10px; background:#000; border-radius:50%; box-shadow: 0 0 0 6px rgba(0,0,0,.08) }

    .links{ display:flex; gap:12px; flex-wrap:wrap; margin-left: 8px }
    .links a{ text-decoration:none; color:#111; padding:8px 10px; border-radius:8px; border:1px solid transparent }
    .links a:hover{ border-color: var(--border); background:#fafafa }

    .flex-spacer{ flex:1 }

    /* Hero (grid lines + shapes) */
    .hero{
      position:relative; overflow:hidden; border-bottom: 1px solid var(--border);
      background:
        repeating-linear-gradient(90deg, #f7f7f7, #f7f7f7 1px, transparent 1px, transparent 18px),
        repeating-linear-gradient(0deg,  #f7f7f7, #f7f7f7 1px, transparent 1px, transparent 18px),
        var(--bg);
    }
    .hero-inner{ padding: clamp(40px, 7vw, 70px) 0 32px; }
    .cta{ display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius: 999px; padding: 10px 16px; border:1px solid #111; background:#111; color:#fff;
      text-decoration:none; box-shadow: var(--shadow); min-height: var(--btnH); cursor: pointer;
    }
    .btn.secondary{ background:#fff; color:#111 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .shapes{ pointer-events:none }
    .shape{ position:absolute; filter: blur(1px); opacity:.08; background:#000; border-radius: 50%; }
    .shape.s1{ width:280px; height:280px; top:-60px; right:-60px; box-shadow: 0 0 0 18px rgba(0,0,0,.06) }
    .shape.s2{ width:180px; height:180px; bottom:-50px; left:-30px; box-shadow: 0 0 0 12px rgba(0,0,0,.05) }

    /* Sections / cards */
    section{ padding: clamp(28px, 6vw, 50px) 0 }
    .grid{ display:grid; gap: var(--gap); grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .card{
      background: var(--card); border:1px solid var(--border); border-radius: var(--radius);
      padding: clamp(14px, 2vw, 18px); box-shadow: var(--shadow);
    }
    .hr{ height:1px; background: var(--border); margin: clamp(18px, 4vw, 28px) 0 }

    /* Form */
    .form{
      display:grid; gap: var(--gap);
      grid-template-columns: 1fr 1fr;
    }
    .field{ display:flex; flex-direction: column; gap:8px }
    .field label{ font-weight:600; font-size: 14px }
    .field input[type="url"],
    .field input[type="text"],
    .field select{
      height: var(--btnH);
      border:1px solid var(--border); border-radius: 12px; padding: 10px 12px;
      background:#fff; color:#111; box-shadow: var(--shadow-soft);
    }
    .field .help{ font-size: 12px; color:#777 }
    .row{ display:flex; gap: 10px; flex-wrap: wrap }
    .row .btn{ flex: 0 0 auto }

    .span-2{ grid-column: 1 / -1 }
    .muted{ color:#777; font-size: 13px }

    /* Fake progress */
    .prog{ height: 10px; background:#f2f2f2; border-radius: 999px; overflow:hidden; border:1px solid var(--border) }
    .bar{ height:100%; width: 0%; background:#111; transition: width .4s ease }

    .hidden{ display: none !important }

    /* Footer */
    footer{ border-top: 1px solid var(--border); padding: 22px 0; color:#555; font-size: 14px }

    /* Back to top */
    .to-top{
      position: fixed; right: 16px; bottom: 16px; z-index: 40;
      display:inline-flex; align-items:center; gap:8px; background:#111; color:#fff; border:1px solid #111; border-radius: 999px;
      padding: 10px 14px; box-shadow: var(--shadow-soft); text-decoration:none;
    }

    /* Responsive */
    @media (max-width: 980px){
      .form{ grid-template-columns: 1fr }
      .span-2{ grid-column: auto }
    }
    @media (max-width: 860px){
      .links--desktop{ display:none }
      .shape{ display:none }
      .nav{ min-height: 56px }
    }

    /* Large monitors: 1920×1080 fit */
    @media (min-width: 1400px){
      :root{ --maxw: min(1864px, calc(100vw - 2*var(--padX))); }
      .hero{ min-height: calc(100vh - var(--headerH)); display:flex; align-items:center; }
      .hero-inner{ width:100%; padding-top: clamp(24px, 5vh, 48px); padding-bottom: clamp(24px, 5vh, 48px); }
      .grid{ grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body id="top">
  <header class="header">
    <div class="container nav">
      <div class="logo"><span class="dot"></span>EthicaDL</div>
      <nav class="links links--desktop" aria-label="Primary">
        <a href="#downloader">Downloader</a>
        <a href="#about">About</a>
      </nav>
      <div class="flex-spacer"></div>
    </div>
  </header>

  <div class="hero">
    <div class="shapes">
      <div class="shape s1"></div>
      <div class="shape s2"></div>
    </div>
    <div class="container hero-inner">
      <span class="pill">⚪︎ Black & White UI</span>
      <h1>Ethica — Video Downloader</h1>
      <p class="lead">
        Paste a video URL, pick a resolution (or audio‑only), and start the download.
      </p>
      <div class="cta">
        <a class="btn" href="#downloader">Open Downloader</a>
        <a class="btn secondary" href="#about">Read About</a>
      </div>
    </div>
  </div>

  <main class="container">
    <section id="downloader">
      <h2 class="section-title">Downloader</h2>
      <div class="card">
        <form class="form" onsubmit="return false">
          <div class="field span-2">
            <label for="url">Video URL</label>
            <input id="url" type="url" placeholder="https://..." required />
            <div class="help">Use only if you have permission to download.</div>
          </div>

          <div class="field">
            <label for="resolution">Resolution</label>
            <select id="resolution">
              <option value="1">8K (4320p)</option>
              <option value="2">4K (2160p)</option>
              <option value="3">2K (1440p)</option>
              <option value="4" selected>1080p</option>
              <option value="5">720p</option>
              <option value="6">480p</option>
              <option value="7">360p</option>
              <option value="8">240p</option>
              <option value="9">144p</option>
              <option value="10">Audio only</option>
            </select>
          </div>

          <div class="field" id="mergeWrap">
            <label for="merge">Merged output</label>
            <select id="merge">
              <option value="mp4" selected>MP4 (merge when needed)</option>
              <option value="mkv">MKV (fallback-friendly)</option>
              <option value="auto">Auto</option>
            </select>
            <div class="help">Used when video+audio tracks merge is needed.</div>
          </div>

          <div class="field hidden" id="audioWrap">
            <label for="audioFmt">Audio format</label>
            <select id="audioFmt">
              <option value="m4a" selected>M4A</option>
              <option value="mp3">MP3</option>
              <option value="opus">Opus</option>
              <option value="wav">WAV</option>
            </select>
            <div class="help">Shown only when “Audio only” is selected.</div>
          </div>

          <!-- User-Agent chooser -->
          <div class="field span-2">
            <label for="uaChoice">User-Agent (optional)</label>
            <div class="row">
              <select id="uaChoice">
                <option value="">Default (server)</option>
                <option value="chrome_win">Chrome — Windows</option>
                <option value="firefox_linux">Firefox — Linux</option>
                <option value="safari_mac">Safari — macOS</option>
                <option value="chrome_android">Chrome — Android</option>
                <option value="safari_ios">Safari — iPhone</option>
                <option value="custom">Custom…</option>
              </select>
              <input id="uaCustom" class="hidden" type="text" placeholder="Paste your custom User-Agent string" />
            </div>
            <div class="help">Pick one or choose “Custom…” to paste your own.</div>
          </div>

          <!-- Output filename with Auto/Custom -->
          <div class="field span-2">
            <label for="filenameChoice">Output filename</label>
            <div class="row">
              <select id="filenameChoice">
                <option value="">Auto</option>
                <option value="custom">Custom…</option>
              </select>
              <input id="filenameCustom" class="hidden" type="text" placeholder="e.g. MyVideo.mp4 or a yt-dlp template" />
            </div>
            <div class="help">Auto uses server default naming. Custom lets you type a name or a yt-dlp template.</div>
          </div>

          <div class="span-2">
            <div class="row">
              <button id="btnStart" class="btn" type="button">Start Download</button>
              <button id="btnReset" class="btn secondary" type="reset">Reset</button>
            </div>
            <div style="margin-top:10px" class="muted">Status and progress will appear below.</div>
          </div>

          <div class="span-2">
            <div class="prog"><div id="bar" class="bar"></div></div>
            <div id="status" class="muted" style="margin-top:8px">Idle</div>
          </div>
        </form>
      </div>
    </section>

    <div class="hr"></div>

    <section id="about">
      <h2 class="section-title">About & Legal</h2>
      <div class="card">
        <p>
          EthicaDL is a simple, fast and secure solution for downloading videos and your own content that you have
          permission to download. Our goal is to help you download files in the quality you want (1080p, 720p,
          audio-only, ...) from an upload URL through a simple UI. We work within the rules and respect people's rights,
          and we emphasize that you only download videos that you know and have permission to download before proceeding.
        </p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div>© 2025 EthicaDL. Monochrome UI inspired by Ethica.</div>
    </div>
  </footer>

  <a class="to-top" href="#top" title="Back to top">⬆ Back to top</a>

  <script>
  // If UI and backend are on the same Flask server, keep empty.
  // If frontend is separate, set e.g. const API_BASE = 'https://your-backend.example.com';
  const API_BASE = '';

  // Helpers
  const $ = (s, c=document) => c.querySelector(s);
  function safe(el, name){ if(!el){ console.error(`[UI] Missing element: ${name}`); throw new Error(`Missing ${name}`); } return el; }

  window.addEventListener('DOMContentLoaded', () => {
    // Grab elements (fail fast if IDs mismatch)
    const resolution      = safe($('#resolution'), 'resolution');
    const mergeSelect     = $('#merge');      // optional
    const audioFmt        = $('#audioFmt');   // optional
    const audioWrap       = safe($('#audioWrap'), 'audioWrap');
    const mergeWrap       = safe($('#mergeWrap'), 'mergeWrap');

    const uaChoice        = safe($('#uaChoice'), 'uaChoice');
    const uaCustom        = safe($('#uaCustom'), 'uaCustom');

    const filenameChoice  = safe($('#filenameChoice'), 'filenameChoice');
    const filenameCustom  = safe($('#filenameCustom'), 'filenameCustom');

    const btnStart        = safe($('#btnStart'), 'btnStart');
    const btnReset        = safe($('#btnReset'), 'btnReset');
    const bar             = safe($('#bar'), 'bar');
    const statusEl        = safe($('#status'), 'status');

    // Toggle helpers
    function updateFields(){
      const isAudio = resolution.value === '10';
      audioWrap.classList.toggle('hidden', !isAudio);
      mergeWrap.classList.toggle('hidden', isAudio);
    }
    function updateUAFields(){
      if(uaChoice.value === 'custom'){ uaCustom.classList.remove('hidden'); uaCustom.focus(); }
      else { uaCustom.classList.add('hidden'); }
    }
    function updateFilenameFields(){
      if(filenameChoice.value === 'custom'){ filenameCustom.classList.remove('hidden'); filenameCustom.focus(); }
      else { filenameCustom.classList.add('hidden'); }
    }
    resolution.addEventListener('change', updateFields);
    uaChoice.addEventListener('change', updateUAFields);
    filenameChoice.addEventListener('change', updateFilenameFields);
    updateFields(); updateUAFields(); updateFilenameFields();

    // Progress UI
    let pollTimer = null;
    function setProgress(pct, text){
      if(typeof pct === 'number'){
        const clamped = Math.max(0, Math.min(100, pct));
        bar.style.width = clamped.toFixed(0) + '%';
      }
      statusEl.textContent = text || '';
    }

    // Parse filename from Content-Disposition
    function parseFilename(dispo){
      if(!dispo) return null;
      const utf8 = dispo.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
      if(utf8){ try{ return decodeURIComponent(utf8[1]); }catch(e){} }
      const quoted = dispo.match(/filename\s*=\s*"([^"]+)"/i);
      if(quoted) return quoted[1];
      const plain = dispo.match(/filename\s*=\s*([^;]+)/i);
      if(plain) return plain[1].trim();
      return null;
    }

    // Robust programmatic download
    async function downloadNow(jobId, btnEl){
      const fileUrl = (API_BASE || '') + '/api/file/' + jobId;
      try{
        if(btnEl){ btnEl.disabled = true; btnEl.textContent = 'Preparing…'; }
        const resp = await fetch(fileUrl, { method: 'GET' });
        if(!resp.ok) throw new Error('Server responded ' + resp.status);
        const blob = await resp.blob();

        let fname = parseFilename(resp.headers.get('Content-Disposition')) || ('download-' + jobId);
        if(!/\.[a-z0-9]{2,5}$/i.test(fname)){
          const map = {
            'video/mp4': '.mp4', 'video/webm': '.webm',
            'audio/m4a': '.m4a', 'audio/mp3': '.mp3',
            'audio/ogg': '.ogg', 'audio/webm': '.webm'
          };
          const guess = map[blob.type];
          if(guess) fname += guess;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);

        if(btnEl){ btnEl.textContent = '⬇ Download'; btnEl.disabled = false; }
      }catch(err){
        if(btnEl){ btnEl.disabled = false; btnEl.textContent = 'Try again'; }
        alert('Download failed: ' + err.message);
      }
    }

    // Start download
    async function startDownload(){
      console.log('[UI] Start clicked');
      const url = ($('#url').value || '').trim();
      if(!url){ alert('Please paste a video URL'); return; }

      const payload = {
        url,
        resolution:        resolution.value,
        merge:             mergeSelect ? mergeSelect.value : 'auto',
        audioFmt:          audioFmt ? audioFmt.value : 'm4a',
        uaChoice:          uaChoice.value,
        uaCustom:         (uaCustom.value || '').trim(),
        filenameChoice:    filenameChoice.value,
        filenameCustom:   (filenameCustom.value || '').trim()
        // cookiesFrom: 'chrome' // enable from UI later if needed
      };

      btnStart.disabled = true;
      setProgress(0, 'Starting…');

      try{
        const res  = await fetch((API_BASE || '') + '/api/download', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Start failed');
        console.log('[UI] Job id:', data.job_id);
        poll(data.job_id);
      }catch(err){
        console.error('[UI] Start error:', err);
        btnStart.disabled = false;
        setProgress(0, 'Error: ' + err.message);
      }
    }

    // Poll status
    function poll(jobId){
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async ()=>{
        try{
          const r = await fetch((API_BASE || '') + '/api/status/' + jobId);
          const s = await r.json();
          if(!r.ok) throw new Error(s.error || 'Status error');

          if(s.state === 'downloading'){
            const pct = typeof s.progress === 'number' ? s.progress : 0;
            setProgress(pct, 'Downloading… ' + Math.round(pct) + '%');
          }else if(s.state === 'processing'){
            setProgress(100, 'Processing…');
          }else if(s.state === 'finished' || s.ready){
            clearInterval(pollTimer); pollTimer = null;
            setProgress(100, '');
            // Show Download + Copy buttons
            statusEl.innerHTML = `
              <div class="row" style="gap:8px; align-items:center">
                <span class="muted">Done.</span>
                <button id="dlBtn" class="btn" type="button">⬇ Download</button>
                <button id="copyLink" class="btn secondary" type="button">Copy link</button>
              </div>`;
            const dlBtn   = $('#dlBtn');
            const copyBtn = $('#copyLink');
            const fileHref = (API_BASE || '') + '/api/file/' + jobId;

            if(dlBtn){
              dlBtn.addEventListener('click', ()=> downloadNow(jobId, dlBtn));
            }
            if(copyBtn){
              copyBtn.addEventListener('click', ()=>{
                navigator.clipboard.writeText(fileHref).then(()=>{
                  copyBtn.textContent = 'Copied!';
                  setTimeout(()=> copyBtn.textContent = 'Copy link', 1200);
                }).catch(()=> alert('Copy failed'));
              });
            }
            btnStart.disabled = false;
          }else if(s.state === 'error'){
            clearInterval(pollTimer); pollTimer = null;
            setProgress(0, 'Error: ' + (s.error || 'Unknown'));
            btnStart.disabled = false;
          }else{
            setProgress(0, s.state || 'Queued…');
          }
        }catch(err){
          clearInterval(pollTimer); pollTimer = null;
          console.error('[UI] Poll error:', err);
          setProgress(0, 'Error: ' + err.message);
          btnStart.disabled = false;
        }
      }, 800);
    }

    // Bind events (after DOM ready)
    btnStart.addEventListener('click', startDownload);
    btnReset.addEventListener('click', ()=>{
      if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
      bar.style.width = '0%';
      statusEl.textContent = 'Idle';
      btnStart.disabled = false;
    });
  });
</script>
</body>
</html>